<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ•°å­—ç©ºé—´ | å¥‹æ–—åœ¨ 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.5.10/dist/typography.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root { --primary: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; scroll-behavior: smooth; overflow-x: hidden; }

        /* å›å½’ç®€å•å¡ç‰‡é£æ ¼ */
        .simple-card { 
            background: #ffffff; 
            border: 1px solid #e2e8f0; 
            border-radius: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .canvas-container { position: relative; width: 100%; height: 240px; cursor: crosshair; touch-action: none; background: #fff; border-radius: 0.5rem; }
        .hidden-view { display: none; opacity: 0; }
        .view-content { transition: opacity 0.2s ease-in-out; }
        
        /* æ–‡ç« å†…å®¹æ˜¾ç¤º */
        .content-body img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1.5rem 0; display: block; border: 1px solid #e2e8f0; }
        .content-body a { color: var(--primary); text-decoration: underline; font-weight: 600; }
        
        .article-card { transition: transform 0.2s, box-shadow 0.2s; }
        .article-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .number-input { @apply bg-slate-50 border border-slate-200 rounded-md text-sm font-semibold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500/20 p-2.5 w-full; }
    </style>
</head>
<body class="text-slate-800 antialiased text-left">

    <!-- ç®€å•å¯¼èˆªæ  -->
    <nav class="sticky top-0 z-50 bg-white border-b border-slate-200 py-4 px-6 mb-8">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex flex-col cursor-pointer" onclick="window.showView('home')">
                <h1 id="nav-site-title" class="text-xl font-bold text-indigo-600 select-none">STRIVE 2026</h1>
                <p class="text-[10px] text-slate-400">ï¼ˆæµè§ˆè¯¥åšå®¢éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼‰</p>
            </div>
            <div class="flex items-center space-x-6">
                <a href="javascript:void(0)" onclick="window.showView('home')" class="text-sm font-medium text-slate-600 hover:text-indigo-600">é¦–é¡µ</a>
                <a id="nav-admin-link" href="javascript:void(0)" onclick="window.checkAdminAuth()" class="text-sm font-medium text-slate-600 hover:text-indigo-600">ç®¡ç†</a>
                <a id="nav-contact-btn" href="#" target="_blank" class="bg-indigo-600 text-white px-4 py-1.5 rounded-md text-sm font-bold hover:bg-indigo-700">è”ç³»æˆ‘</a>
            </div>
        </div>
    </nav>

    <!-- ç®¡ç†å‘˜ç™»å½•å¼¹çª— -->
    <div id="auth-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-8 shadow-xl">
            <h3 class="text-lg font-bold mb-4 text-center">ç®¡ç†å‘˜èº«ä»½éªŒè¯</h3>
            <form id="login-form">
                <div class="space-y-4">
                    <!-- ä¿®å¤ï¼šæ–‡æ¡ˆæ”¹ä¸ºç®¡ç†å‘˜å¯†ç  -->
                    <input type="password" id="admin-password-input" class="w-full p-3 border border-slate-200 rounded-md outline-none focus:ring-2 focus:ring-indigo-500 text-center" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md font-bold">ç¡®å®š</button>
                        <button type="button" onclick="window.closeAuthModal()" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-md font-bold">å–æ¶ˆ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-8 pb-20">
        
        <div class="lg:col-span-2 space-y-8">
            <!-- é¦–é¡µå†…å®¹ -->
            <div id="home-view" class="view-content space-y-8">
                <div class="simple-card p-8 md:p-12">
                    <h2 id="welcome-title" class="text-3xl font-bold mb-4 text-slate-900">ä½ å¥½ ğŸ‘‹</h2>
                    <p id="welcome-desc" class="text-slate-500 text-lg leading-relaxed mb-6 italic">æ•°æ®åŠ è½½ä¸­...</p>
                    <div id="welcome-tags" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-lg font-bold flex items-center gap-2 text-slate-800 border-l-4 border-indigo-600 pl-3">
                        æœ€æ–°æ—¥å¿—
                    </h3>
                    <div id="article-list" class="grid gap-6"></div>
                </div>
            </div>

            <!-- æ–‡ç« è¯¦æƒ… -->
            <div id="article-view" class="view-content hidden-view space-y-8">
                <button onclick="window.showView('home')" class="text-sm font-bold text-slate-400 hover:text-indigo-600 flex items-center gap-1">
                    â† è¿”å›åˆ—è¡¨
                </button>
                <div class="simple-card p-8 md:p-12">
                    <div id="article-detail-content" class="prose prose-slate max-w-none content-body"></div>
                </div>
                <!-- äº’åŠ¨è¯„è®º -->
                <div class="simple-card p-8 space-y-8">
                    <h3 class="text-xl font-bold">äº’åŠ¨äº¤æµ</h3>
                    <div class="space-y-4 bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <input type="text" id="comment-name" placeholder="æ‚¨çš„ç§°å‘¼" class="w-full md:w-1/2 p-3 border border-slate-200 rounded-md text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                        <textarea id="comment-content" rows="3" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." class="w-full p-3 border border-slate-200 rounded-md text-sm outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        <button onclick="window.submitComment()" id="comment-submit-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md font-bold text-sm">å‘è¡¨è¯„è®º</button>
                    </div>
                    <div id="comments-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- ç®¡ç†åå° -->
            <div id="admin-view" class="view-content hidden-view space-y-8">
                <div class="flex justify-between items-center simple-card p-6">
                    <h2 class="text-xl font-bold">ç®¡ç†æ§åˆ¶å°</h2>
                    <div class="flex gap-2">
                        <button onclick="window.logoutAdmin()" class="px-4 py-1.5 bg-slate-100 text-slate-500 rounded-md text-xs font-bold">æ³¨é”€</button>
                        <button onclick="window.openEditor()" class="px-4 py-1.5 bg-indigo-600 text-white rounded-md text-xs font-bold">+ æ–°å»ºå†…å®¹</button>
                    </div>
                </div>
                <div class="simple-card p-8 space-y-8">
                    <h3 class="text-sm font-bold text-indigo-600 uppercase tracking-wider">ç«™ç‚¹é…ç½®</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs text-slate-400 font-bold">ç«™ç‚¹åå­—</label>
                            <input type="text" id="set-site-title" class="w-full p-3 border border-slate-200 rounded-md outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-400 font-bold">è”ç³»é“¾æ¥</label>
                            <input type="text" id="set-contact-link" class="w-full p-3 border border-slate-200 rounded-md outline-none">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs text-slate-400 font-bold">ä¸»é¡µå¤§æ ‡é¢˜</label>
                            <input type="text" id="set-welcome-title" class="w-full p-3 border border-slate-200 rounded-md outline-none font-bold">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs text-slate-400 font-bold">ä¸ªäººç®€ä»‹</label>
                            <textarea id="set-welcome-desc" rows="2" class="w-full p-3 border border-slate-200 rounded-md outline-none"></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-400 font-bold">æ ‡ç­¾ 1</label>
                            <input type="text" id="set-tag1" class="w-full p-3 border border-slate-200 rounded-md outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-400 font-bold">æ ‡ç­¾ 2</label>
                            <input type="text" id="set-tag2" class="w-full p-3 border border-slate-200 rounded-md outline-none">
                        </div>
                    </div>
                    <button onclick="window.saveSettings()" id="save-settings-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-md">ä¿å­˜å¹¶åŒæ­¥</button>
                </div>
                <div id="admin-table-body" class="simple-card overflow-hidden"></div>
            </div>

            <!-- ç¼–è¾‘å™¨ -->
            <div id="editor-view" class="view-content hidden-view space-y-8">
                <div class="simple-card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">å†…å®¹å·¥ä½œå®¤</h3>
                        <div class="flex gap-2">
                            <label class="px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-bold rounded cursor-pointer">è´´å›¾<input type="file" id="image-upload" accept="image/*" class="hidden"></label>
                            <label class="px-3 py-1 bg-emerald-50 text-emerald-600 text-xs font-bold rounded cursor-pointer">é™„ä»¶<input type="file" id="file-upload" class="hidden"></label>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <input type="hidden" id="edit-id">
                        <input type="text" id="post-title" placeholder="åšæ–‡æ ‡é¢˜" class="w-full p-4 border border-slate-200 rounded-md outline-none text-xl font-bold">
                        <textarea id="post-summary" placeholder="é¦–é¡µæ‘˜è¦..." rows="2" class="w-full p-4 border border-slate-200 rounded-md outline-none font-medium text-slate-500"></textarea>
                        <textarea id="post-content" placeholder="è®°å½•ä½ çš„å¥‹æ–— (æ”¯æŒç›´æ¥ç²˜è´´å›¾ç‰‡)..." rows="18" class="w-full p-6 border border-slate-200 rounded-md outline-none font-mono text-base leading-relaxed"></textarea>
                        <div class="flex gap-4 pt-4">
                            <button type="button" onclick="window.submitPost()" id="post-submit-btn" class="flex-[2] bg-indigo-600 text-white py-3 rounded-md font-bold">å‘å¸ƒåŒæ­¥</button>
                            <button type="button" onclick="window.showView('admin')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-md font-bold">å–æ¶ˆè¿”å›</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ  -->
        <div class="lg:col-span-1 space-y-8">
            <!-- å€’è®¡æ—¶ -->
            <div class="bg-slate-800 text-white p-8 rounded-2xl shadow-lg relative overflow-hidden">
                <h3 class="text-sm font-bold mb-4 text-slate-400">2026 å¥‹æ–—è¿›åº¦</h3>
                <div class="text-5xl font-bold mb-6 tabular-nums" id="countdown">...</div>
                <div class="w-full bg-slate-700 rounded-full h-2 mb-4">
                    <div id="progress-bar" class="bg-indigo-500 h-full rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
                </div>
                <p class="text-[10px] text-slate-400" id="progress-text">åŒæ­¥ä¸­...</p>
            </div>

            <!-- å¤åˆ©æ¨¡æ‹Ÿå™¨ -->
            <div class="simple-card p-8 space-y-8">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-slate-900">å¤åˆ©æ¨¡æ‹Ÿå™¨</h3>
                    <span class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-400">V2.2</span>
                </div>
                <div class="canvas-container">
                    <canvas id="compoundCanvas"></canvas>
                    <div id="chart-tooltip" class="absolute hidden pointer-events-none bg-slate-900/95 text-white text-[11px] p-4 rounded-lg shadow-xl z-20 border border-white/10 min-w-[170px]"></div>
                </div>
                <!-- ä¿®å¤ï¼šå°†è¾“å…¥æ¡†æ”¹ä¸ºå‚ç›´å †å ï¼Œå½»åº•è§£å†³é‡å é—®é¢˜ -->
                <div class="space-y-5">
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400">åˆå§‹æœ¬é‡‘ (Â¥)</label>
                            <input type="number" id="inputPrincipal" value="10000" class="number-input">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400">æ¯æœˆå®šæŠ• (Â¥)</label>
                            <input type="number" id="inputMonthly" value="2000" class="number-input">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-bold">
                            <span class="text-slate-400">æŠ•èµ„å¹´é™</span>
                            <span class="text-indigo-600"><span id="yearsVal">20</span>å¹´</span>
                        </div>
                        <input type="range" id="yearsInput" min="1" max="40" value="20" class="w-full h-1.5 bg-slate-100 rounded-lg cursor-pointer">
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-bold">
                            <span class="text-slate-400">å¹´åŒ–æ”¶ç›Š</span>
                            <span class="text-indigo-600"><span id="rateVal">8</span>%</span>
                        </div>
                        <input type="range" id="rateInput" min="1" max="15" value="8" class="w-full h-1.5 bg-slate-100 rounded-lg cursor-pointer">
                    </div>
                </div>
                <div class="pt-6 border-t border-slate-50 text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold uppercase tracking-widest">é¢„æœŸæœ€ç»ˆèµ„äº§</div>
                    <div class="text-3xl font-bold text-indigo-600 tabular-nums" id="finalWealth">...</div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, Timestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const ADMIN_MASK = "WFlGeHlmMTIzNDU2QA=="; 
        const PERSIST_KEY = "luxiaoyu_blog_p_v11_responsive_revert_visual"; 
        const fbConfig = { apiKey: "AIzaSyAVxcXzx1rxI1R6MaUpvwkhsJA5tFCmlKU", authDomain: "blog-6dd2d.firebaseapp.com", projectId: "blog-6dd2d", storageBucket: "blog-6dd2d.firebasestorage.app", messagingSenderId: "232992420063", appId: "1:232992420063:web:4afa71559dbf14ed47f96a", measurementId: "G-JV2BY25CFH" };
        const app = initializeApp(fbConfig); const auth = getAuth(app); const db = getFirestore(app); const appId = 'blog-6dd2d';
        const articlesCol = collection(db, 'artifacts', appId, 'public', 'data', 'articles');
        const settingsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main');
        const securityCol = collection(db, 'artifacts', appId, 'public', 'data', 'security');
        const commentsCol = collection(db, 'artifacts', appId, 'public', 'data', 'comments');

        let isAdminAuthenticated = false, articles = [], comments = [], currentArticleId = null, user = null, securityRecord = null;
        window.tempMediaMap = {};

        async function syncSecurityRecord() { if (!user) return; try { const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'security', user.uid)); securityRecord = snap.exists() ? snap.data() : { failedAttempts: 0, lockoutUntil: 0 }; } catch(e) {} }

        // --- è®¤è¯ ---
        window.submitAuth = async (e) => {
            if (e && e.preventDefault) e.preventDefault();
            const input = document.getElementById('admin-password-input').value, now = Date.now();
            await syncSecurityRecord();
            if (securityRecord?.lockoutUntil > now) return alert(`ç®¡ç†å‘˜è®¿é—®é”å®šä¸­ï¼Œè¯·ç¨åå†è¯•ã€‚`);
            if (btoa(input) === ADMIN_MASK) { 
                isAdminAuthenticated = true; localStorage.setItem(PERSIST_KEY, ADMIN_MASK);
                await setDoc(doc(securityCol, user.uid), { failedAttempts: 0, lockoutUntil: 0 });
                window.closeAuthModal(); window.showView('admin');
            } else {
                let attempts = (securityRecord?.failedAttempts || 0) + 1;
                let lockoutTime = attempts >= 5 ? now + (5 * 60 * 1000) : 0;
                await setDoc(doc(securityCol, user.uid), { failedAttempts: attempts, lockoutUntil: lockoutTime });
                alert(lockoutTime > 0 ? "å¤šæ¬¡è¾“å…¥é”™è¯¯ï¼Œç®¡ç†å‘˜å¯†ç é”å®š 5 åˆ†é’Ÿã€‚" : `å¯†ç é”™è¯¯ã€‚è¿˜å‰© ${5 - attempts} æ¬¡å°è¯•æœºä¼šã€‚`); await syncSecurityRecord();
            }
        };
        window.checkAdminAuth = () => { if (isAdminAuthenticated || localStorage.getItem(PERSIST_KEY) === ADMIN_MASK) { isAdminAuthenticated = true; window.showView('admin'); } else { const m = document.getElementById('auth-modal'); m.classList.remove('hidden'); m.classList.add('flex'); setTimeout(()=>document.getElementById('admin-password-input')?.focus(), 200); } };
        window.closeAuthModal = () => { const m = document.getElementById('auth-modal'); m?.classList.add('hidden'); m?.classList.remove('flex'); document.getElementById('admin-password-input').value = ""; };
        window.logoutAdmin = () => { localStorage.removeItem(PERSIST_KEY); isAdminAuthenticated = false; window.showView('home'); };

        // --- è·¯ç”± ---
        window.showView = (v, id = null) => { location.hash = `#/${v}${id ? '/' + id : ''}`; };
        const updateUIFromHash = () => {
            const parts = location.hash.replace(/^#\//, '').split('/');
            const view = parts[0] || 'home', id = parts[1] || null;
            const isAuth = isAdminAuthenticated || localStorage.getItem(PERSIST_KEY) === ADMIN_MASK;
            if ((view === 'admin' || view === 'editor') && !isAuth) { location.hash = '#/home'; window.checkAdminAuth(); return; }
            ['home', 'article', 'admin', 'editor'].forEach(x => document.getElementById(x + '-view')?.classList.add('hidden-view'));
            const target = document.getElementById(view + '-view'); if(target) target.classList.remove('hidden-view');
            if (view === 'article' && id) {
                currentArticleId = id; const a = articles.find(x => x.id === id);
                if(a) { 
                    document.getElementById('article-detail-content').innerHTML = `<h1 class="text-3xl font-bold mb-4">${a.title}</h1><div class="text-slate-400 text-xs mb-8">ğŸ“… å‘å¸ƒæ—¶é—´ï¼š${a.date}</div><div class="content-body text-base leading-relaxed">${a.content}</div>`;
                    renderComments();
                }
            } else currentArticleId = null;
            window.scrollTo(0, 0);
        };
        window.addEventListener('hashchange', updateUIFromHash);

        // --- æ•°æ® ---
        function startSettingsListener() {
            onSnapshot(settingsDoc, s => {
                const d = s.exists() ? s.data() : {};
                document.getElementById('nav-site-title').innerText = d.siteTitle || 'STRIVE 2026';
                document.getElementById('welcome-title').innerText = d.welcomeTitle || 'ä½ å¥½ ğŸ‘‹';
                document.getElementById('welcome-desc').innerText = d.welcomeDesc || 'åŒæ­¥äº‘ç«¯ä¸­...';
                const mapping = {'set-site-title':'siteTitle','set-welcome-title':'welcomeTitle','set-welcome-desc':'welcomeDesc','set-contact-link':'contactLink','set-tag1':'tag1','set-tag2':'tag2'};
                for (let [id, key] of Object.entries(mapping)) { const el = document.getElementById(id); if(el) el.value = d[key] || ''; }
                const tagsEl = document.getElementById('welcome-tags'); if(tagsEl) tagsEl.innerHTML = `<span class="px-3 py-1 bg-white border border-slate-200 text-indigo-600 text-[10px] font-bold rounded-md shadow-sm">${d.tag1 || '# 2026è€ƒç ”'}</span><span class="px-3 py-1 bg-white border border-slate-200 text-emerald-600 text-[10px] font-bold rounded-md shadow-sm">${d.tag2 || '# å¥‹æ–—'}</span>`;
                const contactBtn = document.getElementById('nav-contact-btn'); if(contactBtn) { let url = (d.contactLink || '').trim(); if(url && !url.startsWith('http')) url = 'https://' + url; contactBtn.href = url || '#'; }
            });
        }
        window.saveSettings = async () => {
            const btn = document.getElementById('save-settings-btn'); btn.innerText = "æ­£åœ¨åŒæ­¥..."; btn.disabled = true;
            try { await setDoc(settingsDoc, { siteTitle: document.getElementById('set-site-title').value, welcomeTitle: document.getElementById('set-welcome-title').value, welcomeDesc: document.getElementById('set-welcome-desc').value, contactLink: document.getElementById('set-contact-link').value, tag1: document.getElementById('set-tag1').value, tag2: document.getElementById('set-tag2').value }); btn.innerText = "æˆåŠŸåŒæ­¥"; setTimeout(()=> { btn.disabled=false; btn.innerText = "ä¿å­˜å¹¶åŒæ­¥"; }, 2000); } catch(e) { btn.disabled = false; }
        };
        function startDataListener() {
            onSnapshot(articlesCol, s => {
                articles = s.docs.map(d => ({id: d.id, ...d.data()}));
                articles.sort((a, b) => {
                    if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                    const timeA = a.updatedAt?.toMillis() || new Date(a.date?.replace(/\./g,'-').replace(/\s.+/,'')).getTime() || 0;
                    const timeB = b.updatedAt?.toMillis() || new Date(b.date?.replace(/\./g,'-').replace(/\s.+/,'')).getTime() || 0;
                    return timeB - timeA;
                });
                document.getElementById('article-list').innerHTML = articles.map(a => {
                    const imgMatch = a.content.match(/<img[^>]+src="([^">]+)"/);
                    const firstImg = imgMatch ? imgMatch[1] : null;
                    return `<div onclick="window.showView('article', '${a.id}')" class="article-card simple-card p-8 cursor-pointer relative overflow-hidden text-left"><div class="flex flex-col sm:flex-row justify-between gap-6 text-left"><div class="flex-1 min-w-0 text-left">${a.isPinned ? '<span class="inline-block mb-3 bg-indigo-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">ç½®é¡¶</span>' : ''}<h4 class="text-xl font-bold mb-2 group-hover:text-indigo-600 transition-colors text-left">${a.title}</h4><p class="text-slate-500 line-clamp-2 text-sm leading-relaxed mb-4 text-left">${a.summary}</p><div class="flex items-center gap-6 text-left"><span class="text-slate-400 text-[10px] font-bold">ğŸ“… ${a.date.split(' ')[0]}</span><div class="text-indigo-600 text-[10px] font-bold">é˜…è¯»å…¨æ–‡ â†’</div></div></div>${firstImg ? `<div class="w-full sm:w-32 sm:h-32 h-44 shrink-0 rounded-lg overflow-hidden border border-slate-100"><img src="${firstImg}" class="w-full h-full object-cover"></div>` : ''}</div></div>`;
                }).join('');
                document.getElementById('admin-table-body').innerHTML = `<div class="p-4 font-bold text-[10px] uppercase border-b border-slate-100 text-slate-400">åšæ–‡åˆ—è¡¨ç®¡ç†</div>` + articles.map(a => `<div class="flex items-center justify-between p-4 border-t border-slate-100 hover:bg-slate-50 transition-all text-sm"><span class="font-bold text-slate-700 truncate mr-6">${a.isPinned ? 'ğŸ“Œ ' : ''}${a.title}</span><div class="flex shrink-0 gap-4"><button onclick="window.togglePin('${a.id}', ${!!a.isPinned})" class="text-indigo-600 font-bold text-xs">${a.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}</button><button onclick="window.openEditor('${a.id}')" class="text-indigo-600 font-bold text-xs">ç¼–è¾‘</button><button onclick="window.deletePost('${a.id}')" class="text-red-500 font-bold text-xs">åˆ é™¤</button></div></div>`).join('');
                if (location.hash.includes('article')) updateUIFromHash();
            });
        }
        window.togglePin = async (id, currentPinned) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', id), { isPinned: !currentPinned }); } catch (e) {} };
        window.deletePost = id => { if(confirm("ç¡®å®šæ°¸ä¹…åˆ é™¤åšæ–‡ï¼Ÿ")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', id)); };

        // --- å›¾ç‰‡/ç¼–è¾‘å™¨ ---
        const processImageFile = (file) => {
            const reader = new FileReader(); reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas'); let w = img.width, h = img.height;
                    if (w > 1000) { h = (1000 / w) * h; w = 1000; }
                    cvs.width = w; cvs.height = h;
                    cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                    insertPlaceholder(cvs.toDataURL('image/jpeg', 0.7), "å›¾ç‰‡");
                };
            };
            reader.readAsDataURL(file);
        };
        const insertPlaceholder = (realCode, typeName, fileName = '') => {
            const textarea = document.getElementById('post-content');
            const count = Object.keys(window.tempMediaMap).length + 1, placeholder = `[[${typeName}${count}]]`;
            window.tempMediaMap[placeholder] = typeName === "å›¾ç‰‡" ? `<img src="${realCode}">` : `<a href="${realCode}" download="${fileName}">é™„ä»¶ï¼š${fileName}</a>`;
            const s = textarea.selectionStart, e = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, s) + placeholder + textarea.value.substring(e);
        };
        window.openEditor = (id = null) => {
            window.tempMediaMap = {};
            if(id){
                const a = articles.find(x => x.id === id); document.getElementById('edit-id').value = a.id;
                document.getElementById('post-title').value = a.title; document.getElementById('post-summary').value = a.summary;
                let cleanContent = a.content, idx = 1;
                const mediaRegex = /<img src="data:image[^>]+>|<a href="data:[^>]+>[^<]+<\/a>/g;
                let match; while ((match = mediaRegex.exec(a.content)) !== null) {
                    const placeholder = `[[${match[0].startsWith('<img') ? 'å›¾ç‰‡' : 'æ–‡ä»¶'}${idx}]]`;
                    window.tempMediaMap[placeholder] = match[0]; cleanContent = cleanContent.replace(match[0], placeholder); idx++;
                }
                document.getElementById('post-content').value = cleanContent;
            } else { document.getElementById('edit-id').value = ""; document.getElementById('post-title').value = ""; document.getElementById('post-summary').value = ""; document.getElementById('post-content').value = ""; }
            window.showView('editor');
        };
        window.submitPost = async () => {
            const btn = document.getElementById('post-submit-btn'); btn.disabled = true;
            let finalContent = document.getElementById('post-content').value;
            for (const [p, r] of Object.entries(window.tempMediaMap)) finalContent = finalContent.replace(p, r);
            const dateStr = new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g,'.');
            const data = { title: document.getElementById('post-title').value, date: dateStr, summary: document.getElementById('post-summary').value, content: finalContent, updatedAt: Timestamp.now() };
            try { if(document.getElementById('edit-id').value) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', document.getElementById('edit-id').value), data); else await addDoc(articlesCol, { ...data, isPinned: false }); window.showView('admin'); } catch (err) { alert("ä¿å­˜å¤±è´¥ï¼å†…å®¹è¿‡å¤§ï¼"); } finally { btn.disabled = false; }
        };

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function startCommentsListener() { onSnapshot(commentsCol, s => { comments = s.docs.map(d => ({id: d.id, ...d.data()})); if (currentArticleId) renderComments(); }); }
        function renderComments() {
            const listEl = document.getElementById('comments-list'); if (!listEl) return;
            const filtered = comments.filter(c => c.articleId === currentArticleId).sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
            if (filtered.length === 0) { listEl.innerHTML = '<p class="text-slate-400 text-center py-8 italic font-bold">æš‚æ— è¶³è¿¹è®°å½•ã€‚</p>'; return; }
            listEl.innerHTML = filtered.map(c => {
                const dateStr = c.timestamp?.toDate().toLocaleString('zh-CN', {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                return `<div class="p-4 bg-slate-50 rounded-lg border border-slate-100 text-left"><div class="flex justify-between items-start mb-2"><span class="font-bold text-slate-800 text-sm">${c.name || 'è®¿å®¢'}</span><div class="flex items-center gap-3"><span class="text-[10px] text-slate-400">${dateStr}</span>${isAdminAuthenticated || (user && c.uid === user.uid) ? `<button onclick="window.deleteComment('${c.id}')" class="text-slate-300 hover:text-red-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>` : ''}</div></div><p class="text-slate-600 text-sm">${c.content}</p></div>`;
            }).join('');
        }
        window.deleteComment = async (id) => { if(confirm("åˆ é™¤ï¼Ÿ")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'comments', id)); };
        window.submitComment = async () => {
            const n = document.getElementById('comment-name').value.trim(), c = document.getElementById('comment-content').value.trim();
            if (!c) return; const btn = document.getElementById('comment-submit-btn'); btn.disabled = true;
            try { await addDoc(commentsCol, { articleId: currentArticleId, name: n || 'è®¿å®¢', content: c, timestamp: Timestamp.now(), uid: user.uid }); document.getElementById('comment-content').value = ""; } finally { btn.disabled = false; }
        };

        // --- æ¨¡æ‹Ÿå™¨ (ä¿®å¤å˜é‡å¼•ç”¨ä¸ç‚¹ç»˜åˆ¶) ---
        const cvs = document.getElementById('compoundCanvas'), cx = cvs.getContext('2d'), tooltip = document.getElementById('chart-tooltip');
        function renderChart() {
            if (!cvs) return; const w = cvs.width = cvs.parentElement.clientWidth, h = 240; cvs.height = h;
            const p = parseFloat(document.getElementById('inputPrincipal').value) || 0, m = parseFloat(document.getElementById('inputMonthly').value) || 0, yrs = parseInt(document.getElementById('yearsInput').value), r = parseInt(document.getElementById('rateInput').value) / 100;
            let currentChartData = [{year: 0, principal: p, wealth: p, interest: 0}]; let cur = p;
            for(let i = 1; i <= yrs; i++) { 
                cur = cur * (1 + r) + (m * 12); 
                let inv = p + (m * 12 * i); 
                currentChartData.push({ year: i, principal: inv, wealth: cur, interest: Math.max(0, cur - inv) }); 
            }
            const max = currentChartData[currentChartData.length-1].wealth || 1; document.getElementById('finalWealth').innerText = `Â¥${Math.round(max).toLocaleString()}`;
            cx.clearRect(0,0,w,h); cx.strokeStyle = '#f1f5f9'; cx.lineWidth=1; cx.setLineDash([5,5]); for(let i=1;i<5;i++){ cx.beginPath(); cx.moveTo(0,h-(i*h/5)); cx.lineTo(w,h-(i*h/5)); cx.stroke(); }
            cx.setLineDash([]); cx.beginPath(); cx.moveTo(0,h); currentChartData.forEach(d=>cx.lineTo((d.year/yrs)*w,h-(d.principal/max)*(h-50)-25)); cx.lineTo(w,h); cx.fillStyle='rgba(99,102,241,0.5)'; cx.fill();
            cx.beginPath(); cx.moveTo(0,h); currentChartData.forEach(d=>cx.lineTo((d.year/yrs)*w,h-(d.wealth/max)*(h-50)-25)); for(let i=currentChartData.length-1; i>=0; i--){ cx.lineTo((currentChartData[i].year/yrs)*w,h-(currentChartData[i].principal/max)*(h-50)-25); } cx.fillStyle='rgba(16,185,129,0.15)'; cx.fill();
            cx.beginPath(); cx.strokeStyle='#4f46e5'; cx.lineWidth=3; cx.lineCap='round'; currentChartData.forEach((d,i)=>{ const x=(d.year/yrs)*w, y=h-(d.wealth/max)*(h-50)-25; if(i===0) cx.moveTo(x,y); else cx.lineTo(x,y); }); cx.stroke();
            window.lastData = currentChartData;
        }

        const handleChartMove = e => {
            const rect = cvs.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = clientX - rect.left, yrs = parseInt(document.getElementById('yearsInput').value);
            const yr = Math.round((x / cvs.width) * yrs); const d = (window.lastData || []).find(p => p.year === yr);
            if(d) {
                const max = window.lastData[window.lastData.length-1].wealth; 
                const px = (d.year/yrs)*cvs.width, py = 240 - (d.wealth/max)*(240-50)-25;
                tooltip.classList.remove('hidden'); tooltip.style.left = (px > cvs.width - 150 ? px - 180 : px + 20) + 'px'; tooltip.style.top = (py - 100) + 'px';
                tooltip.innerHTML = `<div class="font-bold text-indigo-300 border-b border-white/10 pb-2 mb-3 text-[10px]">ç¬¬ ${d.year} å¹´é¢„æœŸ</div><div class="flex justify-between gap-6 mb-1 text-[11px]"><span>æœ¬é‡‘:</span><span>Â¥${Math.round(d.principal).toLocaleString()}</span></div><div class="flex justify-between gap-6 mb-1 text-emerald-400 text-[11px]"><span>åˆ©æ¯:</span><span>Â¥${Math.round(d.interest).toLocaleString()}</span></div><div class="flex justify-between gap-6 border-t border-white/10 mt-2 pt-2 text-white font-bold text-xs"><span>æ€»è®¡:</span><span>Â¥${Math.round(d.wealth).toLocaleString()}</span></div>`;
                renderChart(); cx.beginPath(); cx.fillStyle = '#4f46e5'; cx.arc(px, py, 10, 0, Math.PI * 2); cx.fill(); cx.strokeStyle = 'white'; cx.lineWidth = 3; cx.stroke();
            }
        };
        cvs.onmousemove = handleChartMove; cvs.ontouchmove = handleChartMove;
        cvs.onmouseleave = cvs.ontouchend = () => { tooltip.classList.add('hidden'); renderChart(); };
        ['yearsInput','rateInput','inputPrincipal','inputMonthly'].forEach(id => document.getElementById(id)?.addEventListener('input', (e) => { const vEl = document.getElementById(id.replace('Input','Val')); if(vEl) vEl.innerText = e.target.value; renderChart(); }));

        // --- åˆå§‹åŒ– ---
        onAuthStateChanged(auth, async (u) => { user = u; if (user) { startDataListener(); startSettingsListener(); startCommentsListener(); await syncSecurityRecord(); if (localStorage.getItem(PERSIST_KEY) === ADMIN_MASK) isAdminAuthenticated = true; } });
        (async () => { try { await signInAnonymously(auth); } catch (e) { console.warn("Firebase Access Restricted"); } })();

        window.addEventListener('load', () => { 
            document.getElementById('login-form')?.addEventListener('submit', window.submitAuth);
            document.getElementById('admin-password-input')?.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); window.submitAuth(); } });
            document.getElementById('image-upload')?.addEventListener('change', (e)=>processImageFile(e.target.files[0]));
            document.getElementById('post-content')?.addEventListener('paste', (e) => { const items = (e.clipboardData || e.originalEvent.clipboardData).items; for (const item of items) { if (item.type.indexOf('image') !== -1) { e.preventDefault(); processImageFile(item.getAsFile()); } } });
            if (location.hash) updateUIFromHash(); renderChart(); 
        });

        setInterval(() => { 
            const tgt = new Date('2026-12-20'), start = new Date('2026-01-01'), now = new Date(); const days = Math.ceil((tgt-now)/86400000); const pct = Math.min(100, Math.max(0, ((now-start)/(tgt-start))*100)); 
            const cEl = document.getElementById('countdown'); if(cEl) cEl.innerText = days + ' å¤©';
            const bEl = document.getElementById('progress-bar'); if(bEl) bEl.style.width = pct + '%'; 
            const tEl = document.getElementById('progress-text'); if(tEl) tEl.innerText = `å·²å®Œæˆ 2026 å¥‹æ–—è¿›åº¦çš„ ${pct.toFixed(1)}%`;
        }, 1000);
    </script>
</body>
</html>